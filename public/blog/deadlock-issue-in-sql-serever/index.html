<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    

<meta property="og:url" content="http://localhost:1313/blog/deadlock-issue-in-sql-serever/">
  <meta property="og:site_name" content="Nobuhiro Tokushige - AI & Cloud Solutions">
  <meta property="og:title" content="Deadlock Issue in SQL Serever">
  <meta property="og:description" content="What is a Deadlock? A deadlock in SQL Server occurs when two or more processes hold locks on resources and each process is waiting for the other to release its lock, causing a cycle where none can proceed.
Why Does It Occur? Deadlocks typically hapen due to:
Concurrent Transactions: Multiple transactions access the same resources in a conflicting order. Locking Order: Processes acquire locks in different sequences, leading to circular wait conditions. Long-Running Transactions: Holding locks for an extended period increases the chance of conflicts. Insufficient Indexing: Poor indexing leads to table scans, increasing lock contention. Blocking Issues: Heavy blocking can escalate to deadlocks if multiple processes wait indefinitely. How Poor Maintenance Can Lead to Deadlocks Fragmented Indexes &amp; Performance Degradation If the database has grown significantly and indexes haven’t been maintained (i.e., no reindexing or rebuilding), queries will take longer to execute. Longer query execution times mean locks are held for extended periods, increasing the chances of deadlocks. Full Logging &amp; Large Transaction Logs If transaction logs are continuously growing without proper backups or truncation, SQL Server might struggle with log management, leading to slower transaction processing. Slow transactions hold locks for longer, making deadlocks more likely. Mass Deletes Without Reindexing Deleting a large number of records without reindexing can leave fragmented pages and inefficient query plans. The database engine might perform table scans instead of index seeks, leading to increased lock contention. Query Plan Changes (Due to Increased Data Size) As the database grows, SQL Server might generate different execution plans that were not optimized for the current data size. This can lead to more locking and blocking, increasing the chance of deadlocks. Demo - Create a test table 1. Create a Large Table &amp; Insert Sample Data USE master; GO CREATE DATABASE ConflictTestDB; GO USE ConflictTestDB; GO CREATE TABLE Orders ( OrderID INT IDENTITY(1,1) PRIMARY KEY, CustomerID INT, OrderDate DATETIME DEFAULT GETDATE(), OrderAmount DECIMAL(10,2), Status VARCHAR(20) ); GO -- Insert ~1 Million Rows SET NOCOUNT ON; DECLARE @i INT = 1; BEGIN TRAN WHILE @i &lt;= 1000000 BEGIN INSERT INTO Orders (CustomerID, OrderAmount, Status) VALUES (ABS(CHECKSUM(NEWID())) % 1000, RAND() * 1000, &#39;Pending&#39;); SET @i = @i &#43; 1; END COMMIT TRAN; GO 2. Create Index Fragmentation (Without Reindexing) -- Delete a large number of records randomly to cause index fragmentation DELETE FROM Orders WHERE OrderID % 10 = 0; GO -- Fill gaps with new inserts (in random order) SET NOCOUNT ON; DECLARE @i INT = 1; BEGIN TRAN WHILE @i &lt;= 100000 BEGIN INSERT INTO Orders (CustomerID, OrderAmount, Status) VALUES (ABS(CHECKSUM(NEWID())) % 1000, RAND() * 1000, &#39;Pending&#39;); SET @i = @i &#43; 1; END COMMIT TRAN; GO 3. Check Fragmentation for All Indexes on [Orders] Table SELECT index_id, index_type_desc, avg_fragmentation_in_percent, avg_page_space_used_in_percent, page_count FROM sys.dm_db_index_physical_stats(DB_ID(), OBJECT_ID(&#39;Orders&#39;), NULL, NULL, &#39;LIMITED&#39;); avg_fragmentation_in_percent → Shows fragmentation level:">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2025-02-09T12:08:42+11:00">
    <meta property="article:modified_time" content="2025-02-09T12:08:42+11:00">
    <meta property="article:tag" content="Maintenace">
    <meta property="article:tag" content="SQL">
    <meta property="article:tag" content="Database">


<meta name="description" content="AI consultant and cloud solutions architect sharing practical insights on AWS, generative AI, and modern DevOps practices. Building the future of AI-powered applications." />
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Nobuhiro Tokushige - AI &amp; Cloud Solutions</title>
    
  
<link rel="icon" type="image/png" href="/images/favicon.png" />
<link href="https://fonts.googleapis.com/css?family=Open&#43;Sans:400,600" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/style.css">
<link rel="stylesheet" type="text/css" href="/css/icons.css">

<link rel="stylesheet" href="http://localhost:1313/custom.css">

  </head>
  <body>
    
    
    <div id="preloader">
      <div id="status"></div>
    </div>
    

    

<nav class="navbar is-fresh is-transparent no-shadow" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
        <img src="/images/logos/IntelliumX-v16.png" alt="" width="112" height="28">
      </a>
      <a class="navbar-item is-hidden-desktop is-hidden-tablet">
        <div id="menu-icon-wrapper" class="menu-icon-wrapper" style="visibility: visible;">
          <svg width="1000px" height="1000px">
            <path class="path1" d="M 300 400 L 700 400 C 900 400 900 750 600 850 A 400 400 0 0 1 200 200 L 800 800"></path>
            <path class="path2" d="M 300 500 L 700 500"></path>
            <path class="path3" d="M 700 600 L 300 600 C 100 600 100 200 400 150 A 400 380 0 1 1 200 800 L 800 200"></path>
          </svg>
          <button id="menu-icon-trigger" class="menu-icon-trigger"></button>
        </div>
      </a>

      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbar-menu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

      <div id="navbar-menu" class="navbar-menu is-static">
        <div class="navbar-start">
          <a class="navbar-item is-hidden-mobile">
            <div id="menu-icon-wrapper" class="menu-icon-wrapper" style="visibility: visible;">
              <svg width="1000px" height="1000px">
                <path class="path1" d="M 300 400 L 700 400 C 900 400 900 750 600 850 A 400 400 0 0 1 200 200 L 800 800"></path>
                <path class="path2" d="M 300 500 L 700 500"></path>
                <path class="path3" d="M 700 600 L 300 600 C 100 600 100 200 400 150 A 400 380 0 1 1 200 800 L 800 200"></path>
              </svg>
              <button id="menu-icon-trigger" class="menu-icon-trigger"></button>
            </div>
          </a>
        </div>

        <div class="navbar-end">
          <a href="/" class="navbar-item is-secondary">
            Home
          </a>
          <a href="/projects/" class="navbar-item is-secondary">
            Projects
          </a>
          <a href="/blog/" class="navbar-item is-secondary">
            Blog
          </a>
          <a href="/about/" class="navbar-item is-secondary">
            About
          </a>
        </div>
      </div>
  </div>
</nav>


<nav id="navbar-clone" class="navbar is-fresh is-transparent" role="navigation" aria-label="main navigation">
  <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="/">
        <img src="/images/logos/IntelliumX-v16.png" alt="" width="112" height="28">
      </a>
      <a class="navbar-item is-hidden-desktop is-hidden-tablet">
        <div id="menu-icon-wrapper" class="menu-icon-wrapper" style="visibility: visible;">
          <svg width="1000px" height="1000px">
            <path class="path1" d="M 300 400 L 700 400 C 900 400 900 750 600 850 A 400 400 0 0 1 200 200 L 800 800"></path>
            <path class="path2" d="M 300 500 L 700 500"></path>
            <path class="path3" d="M 700 600 L 300 600 C 100 600 100 200 400 150 A 400 380 0 1 1 200 800 L 800 200"></path>
          </svg>
          <button id="menu-icon-trigger" class="menu-icon-trigger"></button>
        </div>
      </a>

      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="cloned-navbar-menu">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="cloned-navbar-menu" class="navbar-menu is-fixed">
      <div class="navbar-start">
        <a class="navbar-item is-hidden-mobile">
          <div id="cloned-menu-icon-wrapper" class="menu-icon-wrapper" style="visibility: visible;">
            <svg width="1000px" height="1000px">
              <path class="path1" d="M 300 400 L 700 400 C 900 400 900 750 600 850 A 400 400 0 0 1 200 200 L 800 800"></path>
              <path class="path2" d="M 300 500 L 700 500"></path>
              <path class="path3" d="M 700 600 L 300 600 C 100 600 100 200 400 150 A 400 380 0 1 1 200 800 L 800 200"></path>
            </svg>
            <button id="cloned-menu-icon-trigger" class="menu-icon-trigger"></button>
          </div>
        </a>
      </div>

      <div class="navbar-end">
        <a href="/" class="navbar-item is-secondary">
          Home
        </a>
        <a href="/projects/" class="navbar-item is-secondary">
          Projects
        </a>
        <a href="/blog/" class="navbar-item is-secondary">
          Blog
        </a>
        <a href="/about/" class="navbar-item is-secondary">
          About
        </a>
      </div>
    </div>
</div>
</nav>


<section class="section is-small">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <h1 class="title is-2">Deadlock Issue in SQL Serever</h1>
        <p class="subtitle is-6">February 9, 2025</p>
        <div class="content"><h2 id="what-is-a-deadlock"><strong>What is a Deadlock?</strong></h2>
<p>A deadlock in SQL Server occurs when two or more processes hold locks on resources and each process is waiting for the other to release its lock, causing a cycle where none can proceed.</p>
<h2 id="why-does-it-occur"><strong>Why Does It Occur?</strong></h2>
<p>Deadlocks typically hapen due to:</p>
<ol>
<li><strong>Concurrent Transactions:</strong> Multiple transactions access the same resources in a conflicting order.</li>
<li><strong>Locking Order:</strong> Processes acquire locks in different sequences, leading to circular wait conditions.</li>
<li><strong>Long-Running Transactions:</strong> Holding locks for an extended period increases the chance of conflicts.</li>
<li><strong>Insufficient Indexing:</strong> Poor indexing leads to table scans, increasing lock contention.</li>
<li><strong>Blocking Issues:</strong> Heavy blocking can escalate to deadlocks if multiple processes wait indefinitely.</li>
</ol>
<h2 id="how-poor-maintenance-can-lead-to-deadlocks"><strong>How Poor Maintenance Can Lead to Deadlocks</strong></h2>
<ol>
<li><strong>Fragmented Indexes &amp; Performance Degradation</strong>
<ul>
<li>If the database has grown significantly and indexes haven’t been maintained (i.e., no reindexing or rebuilding), queries will take longer to execute.</li>
<li>Longer query execution times mean locks are held for extended periods, increasing the chances of deadlocks.</li>
</ul>
</li>
<li><strong>Full Logging &amp; Large Transaction Logs</strong>
<ul>
<li>If transaction logs are continuously growing without proper backups or truncation, SQL Server might struggle with log management, leading to slower transaction processing.</li>
<li>Slow transactions hold locks for longer, making deadlocks more likely.</li>
</ul>
</li>
<li><strong>Mass Deletes Without Reindexing</strong>
<ul>
<li>Deleting a large number of records without reindexing can leave fragmented pages and inefficient query plans.</li>
<li>The database engine might perform table scans instead of index seeks, leading to increased lock contention.</li>
</ul>
</li>
<li><strong>Query Plan Changes (Due to Increased Data Size)</strong>
<ul>
<li>As the database grows, SQL Server might generate different execution plans that were not optimized for the current data size.</li>
<li>This can lead to more locking and blocking, increasing the chance of deadlocks.</li>
</ul>
</li>
</ol>
<h2 id="demo---create-a-test-table">Demo - Create a test table</h2>
<h3 id="1-create-a-large-table--insert-sample-data"><strong>1. Create a Large Table &amp; Insert Sample Data</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>USE master;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> ConflictTestDB;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span>USE ConflictTestDB;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> Orders (
</span></span><span style="display:flex;"><span>    OrderID INT <span style="color:#66d9ef">IDENTITY</span>(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>    CustomerID INT,
</span></span><span style="display:flex;"><span>    OrderDate DATETIME <span style="color:#66d9ef">DEFAULT</span> GETDATE(),
</span></span><span style="display:flex;"><span>    OrderAmount DECIMAL(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">2</span>),
</span></span><span style="display:flex;"><span>    Status VARCHAR(<span style="color:#ae81ff">20</span>)
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Insert ~1 Million Rows
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> NOCOUNT <span style="color:#66d9ef">ON</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DECLARE</span> <span style="color:#f92672">@</span>i INT <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span> TRAN
</span></span><span style="display:flex;"><span>WHILE <span style="color:#f92672">@</span>i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1000000</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> Orders (CustomerID, OrderAmount, Status)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">VALUES</span> (<span style="color:#66d9ef">ABS</span>(CHECKSUM(NEWID())) <span style="color:#f92672">%</span> <span style="color:#ae81ff">1000</span>, RAND() <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#e6db74">&#39;Pending&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SET</span> <span style="color:#f92672">@</span>i <span style="color:#f92672">=</span> <span style="color:#f92672">@</span>i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">END</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">COMMIT</span> TRAN;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span></code></pre></div><h3 id="2-create-index-fragmentation-without-reindexing"><strong>2. Create Index Fragmentation (Without Reindexing)</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- Delete a large number of records randomly to cause index fragmentation
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">DELETE</span> <span style="color:#66d9ef">FROM</span> Orders <span style="color:#66d9ef">WHERE</span> OrderID <span style="color:#f92672">%</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Fill gaps with new inserts (in random order)
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">SET</span> NOCOUNT <span style="color:#66d9ef">ON</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DECLARE</span> <span style="color:#f92672">@</span>i INT <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span> TRAN
</span></span><span style="display:flex;"><span>WHILE <span style="color:#f92672">@</span>i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">100000</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> Orders (CustomerID, OrderAmount, Status)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">VALUES</span> (<span style="color:#66d9ef">ABS</span>(CHECKSUM(NEWID())) <span style="color:#f92672">%</span> <span style="color:#ae81ff">1000</span>, RAND() <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>, <span style="color:#e6db74">&#39;Pending&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">SET</span> <span style="color:#f92672">@</span>i <span style="color:#f92672">=</span> <span style="color:#f92672">@</span>i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">END</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">COMMIT</span> TRAN;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span></code></pre></div><h3 id="3-check-fragmentation-for-all-indexes-on-orders-table"><strong>3.</strong> Check Fragmentation for All Indexes on [Orders] Table</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>    index_id,
</span></span><span style="display:flex;"><span>    index_type_desc,
</span></span><span style="display:flex;"><span>    avg_fragmentation_in_percent,
</span></span><span style="display:flex;"><span>    avg_page_space_used_in_percent,
</span></span><span style="display:flex;"><span>    page_count
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> sys.dm_db_index_physical_stats(DB_ID(), OBJECT_ID(<span style="color:#e6db74">&#39;Orders&#39;</span>), <span style="color:#66d9ef">NULL</span>, <span style="color:#66d9ef">NULL</span>, <span style="color:#e6db74">&#39;LIMITED&#39;</span>);
</span></span></code></pre></div><p><strong><code>avg_fragmentation_in_percent</code></strong> → Shows fragmentation level:</p>
<ul>
<li><strong>0-10%</strong> → Good</li>
<li><strong>10-30%</strong> → Consider <strong>reorganizing</strong></li>
<li><strong>30%+</strong> → Consider <strong>rebuilding</strong></li>
</ul>
<h3 id="4--causes-poor-query-plans"><strong>4. [OPTIONAL] Disable Auto Update Statistics</strong> (Causes Poor Query Plans)</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">DATABASE</span> ConflictTestDB <span style="color:#66d9ef">SET</span> AUTO_UPDATE_STATISTICS <span style="color:#66d9ef">OFF</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span></code></pre></div><p><strong>If disabled</strong>, manually update statistics using:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">UPDATE</span> <span style="color:#66d9ef">STATISTICS</span> Orders;
</span></span></code></pre></div><p>or</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> sp_updatestats;
</span></span></code></pre></div><h3 id="what-are-statistics-in-sql-server"><strong>What Are Statistics in SQL Server?</strong></h3>
<p>Statistics help SQL Server’s <strong>query optimizer</strong> decide how to execute queries efficiently. They store <strong>distribution details</strong> about table data, like:</p>
<ul>
<li>Number of distinct values</li>
<li>Data distribution</li>
<li>Index selectivity</li>
</ul>
<p>SQL Server <strong>automatically updates statistics</strong> when:</p>
<ol>
<li>A significant amount of data changes (inserts, updates, deletes).</li>
<li>A query execution detects outdated statistics.</li>
</ol>
<h2 id="demo---create-a-deadlock-in-the-test-table">Demo - Create a Deadlock in the Test Table</h2>
<h3 id="1-run-session-1-query-window-1">1. Run <strong>Session 1 (Query Window 1)</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span> <span style="color:#66d9ef">TRANSACTION</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">UPDATE</span> Orders <span style="color:#66d9ef">SET</span> Status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Processed by Query1&#39;</span> <span style="color:#66d9ef">WHERE</span> OrderID <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>WAITFOR DELAY <span style="color:#e6db74">&#39;00:00:05&#39;</span>;  <span style="color:#75715e">-- Wait to allow Session 2 to lock another row
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">UPDATE</span> Orders <span style="color:#66d9ef">SET</span> OrderAmount <span style="color:#f92672">=</span> OrderAmount <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span> <span style="color:#66d9ef">WHERE</span> OrderID <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">COMMIT</span> <span style="color:#66d9ef">TRANSACTION</span>;
</span></span></code></pre></div><h3 id="2-run-session-2-query-window-2"><strong>2. Run Session 2 (Query Window 2)</strong></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span> <span style="color:#66d9ef">TRANSACTION</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">UPDATE</span> Orders <span style="color:#66d9ef">SET</span> OrderAmount <span style="color:#f92672">=</span> OrderAmount <span style="color:#f92672">+</span> <span style="color:#ae81ff">10</span> <span style="color:#66d9ef">WHERE</span> OrderID <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>WAITFOR DELAY <span style="color:#e6db74">&#39;00:00:05&#39;</span>;  <span style="color:#75715e">-- Wait to allow Session 1 to lock another row
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">UPDATE</span> Orders <span style="color:#66d9ef">SET</span> Status <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Processed by Query2&#39;</span> <span style="color:#66d9ef">WHERE</span> OrderID <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">COMMIT</span> <span style="color:#66d9ef">TRANSACTION</span>;
</span></span></code></pre></div><h3 id="3-run-the-queries-quickly-to-check-the-current-status">3. Run the queries quickly to check the current status</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> sys.dm_tran_locks;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> sys.dm_exec_requests <span style="color:#66d9ef">WHERE</span> blocking_session_id <span style="color:#f92672">&lt;&gt;</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> sp_who2;  
</span></span></code></pre></div><p><img src="2025-02-09-14-11-19.png" alt=""></p>
<h3 id="4-it-throws-a-deadlock-error">4. It throws a deadlock error</h3>
<p><img src="2025-02-09-14-15-49.png" alt=""></p>
<h3 id="5-check-the-event-in-the-log">5. Check the event in the log</h3>
<p>This query below will return entries related to deadlocks from the SQL Server error log, including the process IDs involved, the time when the deadlock occurred, and details about the resource involved in the deadlock.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> xp_readerrorlog <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, N<span style="color:#e6db74">&#39;deadlock&#39;</span>, <span style="color:#66d9ef">NULL</span>, <span style="color:#66d9ef">NULL</span>, <span style="color:#66d9ef">NULL</span>, N<span style="color:#e6db74">&#39;desc&#39;</span>;
</span></span></code></pre></div><p><img src="2025-02-09-14-16-44.png" alt=""></p>
<h2 id="how-page-count-relates-to-performance">How Page Count Relates to Performance:</h2>
<ul>
<li><strong>Large Tables/Indexes</strong>: Tables with many rows or wide rows (containing many columns) will have more pages. SQL queries on these large tables may require more disk reads and thus could be slower unless cached in memory.</li>
<li><strong>Buffer Pool</strong>: The more pages SQL Server can keep in memory, the faster the performance. SQL Server will try to cache frequently used pages in memory (buffer pool). If a table or index fits entirely in memory, it will perform faster than if it needs to be read from disk.</li>
</ul>
<h2 id="how-to-fix-fragmentation">How to fix fragmentation?</h2>
<ul>
<li><strong>Reorganize index (for 10-30% fragmentation)</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">ON</span> Orders REORGANIZE;
</span></span></code></pre></div><ul>
<li><strong>Reorganize index (for 30%+ fragmentation)</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">ON</span> Orders REBUILD;
</span></span></code></pre></div><h2 id="next-steps">Next Steps</h2>
<p>The steps to address the potential causes of deadlocks, especially related to database fragmentation and log table management.</p>
<h3 id="1-check-fragmentation-of-the-log-table">1. <strong>Check Fragmentation of the Log Table</strong></h3>
<ul>
<li><strong>Script</strong>: It helps in understanding how inefficiently space is used. High fragmentation means more I/O operations to read and write data.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> 
</span></span><span style="display:flex;"><span>    index_id,
</span></span><span style="display:flex;"><span>    index_type_desc,
</span></span><span style="display:flex;"><span>    avg_fragmentation_in_percent,
</span></span><span style="display:flex;"><span>    avg_page_space_used_in_percent,
</span></span><span style="display:flex;"><span>    page_count
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> sys.dm_db_index_physical_stats(DB_ID(), OBJECT_ID(<span style="color:#e6db74">&#39;log&#39;</span>), <span style="color:#66d9ef">NULL</span>, <span style="color:#66d9ef">NULL</span>, <span style="color:#e6db74">&#39;LIMITED&#39;</span>);<span style="color:#f92672">||</span>
</span></span></code></pre></div><h3 id="2-write-down-avg_">2. <strong>Write Down avg_fragmentation_in_percent and page_count</strong></h3>
<ul>
<li>Pay particular attention to the <code>avg_fragmentation_in_percent</code> — fragmentation above <strong>30-40%</strong> could significantly impact performance.</li>
</ul>
<h3 id="3-remove-old-logs-and-rebuild-index">3. <strong>Remove Old Logs and Rebuild Index</strong></h3>
<ul>
<li><strong>Log Cleanup</strong>: Before rebuilding, ensure you’ve purged any old logs that are no longer necessary. This will help reduce the overall size and improve performance.</li>
<li><strong>Reindexing</strong>: REBUILD can take time, especially with a table as large as 300GB, and may impact performance temporarily. Ensure you schedule this during a maintenance window or when there’s minimal database load.</li>
</ul>
<p>Single Table</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">INDEX</span> <span style="color:#66d9ef">ALL</span> <span style="color:#66d9ef">ON</span> BPASessionLog_NonUnicode REBUILD;
</span></span></code></pre></div><p>Multiple Tables (Sample 1)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">DECLARE</span> <span style="color:#f92672">@</span>TablesToRebuild <span style="color:#66d9ef">TABLE</span> (TableName NVARCHAR(<span style="color:#ae81ff">255</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Add only the tables you want to rebuild
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> <span style="color:#f92672">@</span>TablesToRebuild (TableName)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">VALUES</span> 
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;BPASession&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;BPASessionLog_NonUnicode&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;BPASessionLog_Unicode&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DECLARE</span> <span style="color:#f92672">@</span>TableName NVARCHAR(<span style="color:#ae81ff">255</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DECLARE</span> TableCursor <span style="color:#66d9ef">CURSOR</span> <span style="color:#66d9ef">FOR</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> TableName <span style="color:#66d9ef">FROM</span> <span style="color:#f92672">@</span>TablesToRebuild;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">OPEN</span> TableCursor;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FETCH</span> <span style="color:#66d9ef">NEXT</span> <span style="color:#66d9ef">FROM</span> TableCursor <span style="color:#66d9ef">INTO</span> <span style="color:#f92672">@</span>TableName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>WHILE <span style="color:#f92672">@@</span>FETCH_STATUS <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">BEGIN</span>
</span></span><span style="display:flex;"><span>    PRINT <span style="color:#e6db74">&#39;Rebuilding indexes on table: &#39;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">@</span>TableName;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">EXEC</span>(<span style="color:#e6db74">&#39;ALTER INDEX ALL ON &#39;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">@</span>TableName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; REBUILD;&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">FETCH</span> <span style="color:#66d9ef">NEXT</span> <span style="color:#66d9ef">FROM</span> TableCursor <span style="color:#66d9ef">INTO</span> <span style="color:#f92672">@</span>TableName;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">END</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CLOSE</span> TableCursor;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DEALLOCATE</span> TableCursor;
</span></span></code></pre></div><p>Multiple Tables (Sample 2)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">DECLARE</span> <span style="color:#f92672">@</span><span style="color:#66d9ef">sql</span> NVARCHAR(<span style="color:#66d9ef">MAX</span>) <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">@</span><span style="color:#66d9ef">sql</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;ALTER INDEX ALL ON [&#39;</span> <span style="color:#f92672">+</span> TableName <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;] REBUILD;&#39;</span> <span style="color:#f92672">+</span> CHAR(<span style="color:#ae81ff">13</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> (<span style="color:#66d9ef">VALUES</span> 
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;BPASession&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;BPASessionLog_NonUnicode&#39;</span>),
</span></span><span style="display:flex;"><span>    (<span style="color:#e6db74">&#39;BPASessionLog_Unicode&#39;</span>)
</span></span><span style="display:flex;"><span>) <span style="color:#66d9ef">AS</span> TableList(TableName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PRINT <span style="color:#f92672">@</span><span style="color:#66d9ef">sql</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> sp_executesql <span style="color:#f92672">@</span><span style="color:#66d9ef">sql</span>;
</span></span></code></pre></div><h3 id="4-monitor-and-compare-results">4. <strong>Monitor and Compare Results</strong></h3>
<ul>
<li>After the cleanup and reindexing, you should expect a reduction in fragmentation. Monitoring this can help you determine if fragmentation was contributing to the deadlocks.</li>
</ul>
<h3 id="5-monitor-the-system-after-changes">5. <strong>Monitor the System After Changes</strong></h3>
<ul>
<li><strong>Deadlock Monitoring</strong>: Check if any schedule failure due to deadlock issue.</li>
<li><strong>Performance Monitoring</strong>: Monitor CPU, I/O, and memory performance using tools like <strong>SQL Server Management Studio (SSMS)</strong> to ensure the server is not overloaded.</li>
</ul>
<h3 id="6-other-considerations">6. <strong>Other Considerations</strong></h3>
<ul>
<li><strong>Log File Size</strong>: If the log file has grown too large (beyond what is necessary for normal operation), advise the customer to shrink and reindex it.</li>
</ul>
</div>
      </div>
    </div>
  </div>
</section>


<footer class="footer footer-dark">
  <div class="container">
    <div class="columns">
      <div class="column">
        <div class="footer-logo">
          <img src="/images/logos/IntelliumX-v15.png">
        </div>
      </div>
        <div class="column">
          <div class="footer-column">
            <div class="footer-header">
                <h3>Product</h3>
            </div>
            <ul class="link-list">
              <li>
                <a href="/">
                  Discover features
                </a>
              </li>
              <li>
                <a href="/">
                  Why choose our product?
                </a>
              </li>
              <li>
                <a href="/">
                  Compare features
                </a>
              </li>
              <li>
                <a href="/">
                  Our roadmap
                </a>
              </li>
              <li>
                <a href="/agb">
                  AGB
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class="column">
          <div class="footer-column">
            <div class="footer-header">
                <h3>Docs</h3>
            </div>
            <ul class="link-list">
              <li>
                <a href="/">
                  Get started
                </a>
              </li>
              <li>
                <a href="/">
                  User guides
                </a>
              </li>
              <li>
                <a href="/">
                  Admin guide
                </a>
              </li>
              <li>
                <a href="/">
                  Developers
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class="column">
          <div class="footer-column">
            <div class="footer-header">
                <h3>Blog</h3>
            </div>
            <ul class="link-list">
              <li>
                <a href="/blog/">
                  All Posts
                </a>
              </li>
              <li>
                <a href="/about/">
                  About
                </a>
              </li>
            </ul>
          </div>
        </div>
      <div class="column">
        <div class="footer-column">
          <div class="footer-header">
            <h3>Follow Us</h3>
            <nav class="level is-mobile">
              <div class="level-left">
                <a class="level-item" href="https://www.linkedin.com/in/nobuhiro-tokushige/">
                  <span class="icon"><i class="fa fa-linkedin"></i></span>
                </a>
                <a class="level-item" href="https://github.com/nobuhiro-tokushige">
                  <span class="icon"><i class="fa fa-github"></i></span>
                </a>
              </div>
            </nav>
            <a href="https://bulma.io" target="_blank">
              <img src="/images/logos/made-with-bulma.png" alt="Made with Bulma" width="128" height="24">
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>



    
    <div id="backtotop"><a href="#"></a></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://unpkg.com/feather-icons"></script>
<script src="/js/fresh.js"></script>
<script src="/js/jquery.panelslider.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
<script src="/js/active-menu.js"></script>

  </body>
</html>
